{% extends "base.html" %}
{% block title %}Exploitation - Metasploit{% endblock %}
{% block content %}

<div class="container mt-4">
    <h2>üéØ Metasploit Framework</h2>
    <p class="text-muted">Interface d'exploitation simplifi√©e et optimis√©e</p>

    <!-- Alerte de s√©curit√© -->
    <div class="alert alert-danger border-danger">
        <h6>‚ö†Ô∏è AVERTISSEMENT L√âGAL</h6>
        <p class="mb-0">N'utilisez ces outils que sur vos propres syst√®mes ou avec autorisation explicite √©crite. 
        Les tests de p√©n√©tration non autoris√©s sont ill√©gaux.</p>
    </div>

    <!-- Interface d'exploitation unique -->
    <div class="card mt-3">
        <div class="card-header bg-dark text-white">
            <h5>üéØ Configuration de l'exploitation</h5>
        </div>
        <div class="card-body">
            <form id="exploitationForm">
                
                <!-- Cible et port -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <label for="target" class="form-label">üéØ Cible</label>
                        <input type="text" class="form-control" id="target" name="target" 
                               placeholder="192.168.1.100 ou example.com" required>
                        <div class="form-text">IP ou nom d'h√¥te de la cible</div>
                    </div>
                    <div class="col-md-4">
                        <label for="port" class="form-label">üîå Port</label>
                        <input type="number" class="form-control" id="port" name="port" 
                               placeholder="80" min="1" max="65535" required>
                        <div class="form-text">Port de la cible √† exploiter</div>
                    </div>
                </div>

                <!-- S√©lection d'exploit -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="exploit_module" class="form-label">‚ö° Module d'exploitation</label>
                        <select class="form-control" id="exploit_module" name="exploit_module" onchange="updateExploitInfo()" required>
                            <option value="">S√©lectionner un exploit...</option>
                            <option value="exploit/multi/http/php_cgi_arg_injection">PHP CGI Argument Injection</option>
                            <option value="exploit/unix/ftp/vsftpd_234_backdoor">VSFTPD 2.3.4 Backdoor</option>
                            <option value="custom">‚ûï Ajouter un exploit personnalis√©</option>
                        </select>
                    </div>
                </div>

                <!-- Champ exploit personnalis√© (cach√© par d√©faut) -->
                <div class="row mb-3" id="customExploitField" style="display: none;">
                    <div class="col-md-12">
                        <label for="custom_exploit_path" class="form-label">üìù Chemin de l'exploit personnalis√©</label>
                        <input type="text" class="form-control" id="custom_exploit_path" name="custom_exploit_path" 
                               placeholder="exploit/linux/http/custom_exploit">
                        <div class="form-text">Entrez le chemin complet de l'exploit Metasploit</div>
                    </div>
                </div>

                <!-- Informations sur l'exploit s√©lectionn√© -->
                <div class="card mb-3 bg-light" id="exploitInfoCard" style="display: none;">
                    <div class="card-body">
                        <h6 id="exploitInfoTitle">‚ÑπÔ∏è Informations sur l'exploit</h6>
                        <div id="exploitInfoContent">
                            <!-- Contenu dynamique -->
                        </div>
                    </div>
                </div>

                <!-- Variables personnalis√©es -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <label for="custom_options" class="form-label">üìã Variables personnalis√©es (optionnel)</label>
                        <textarea class="form-control" id="custom_options" name="custom_options" rows="3"
                                  placeholder="USERNAME=admin&#10;PASSWORD=password123&#10;CUSTOM_VAR=value"></textarea>
                        <div class="form-text">Format: VARIABLE=valeur (une par ligne)</div>
                    </div>
                </div>

                <!-- Configuration automatique (affichage informatif) -->
                <div class="card mb-3 border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">‚öôÔ∏è Configuration automatique</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>üè† LHOST:</strong> <code>172.20.0.2</code><br>
                                <small class="text-muted">IP de l'attaquant (fixe)</small>
                            </div>
                            <div class="col-md-4">
                                <strong>üîå LPORT:</strong> <code>4444</code><br>
                                <small class="text-muted">Port d'√©coute (automatique)</small>
                            </div>
                            <div class="col-md-4">
                                <strong>üí• Payload:</strong> <span id="autoPayload">Auto-s√©lection</span><br>
                                <small class="text-muted">Charge utile adapt√©e</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bouton d'exploitation -->
                <div class="d-flex justify-content-between">
                    <button type="submit" class="btn btn-danger btn-lg" id="startExploitBtn">
                        üöÄ Lancer l'exploitation
                    </button>
                    <div>
                        <button type="button" class="btn btn-outline-secondary" onclick="loadExploitPresets()">
                            üìã Presets de test
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="showExploitGuide()">
                            üìñ Guide rapide
                        </button>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <!-- Monitoring de l'exploitation -->
    <div class="card mt-3" id="exploitMonitoringCard" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>üéØ Exploitation en cours</h5>
            <span class="badge bg-danger" id="exploitTaskStatus">En cours...</span>
        </div>
        <div class="card-body">
            
            <!-- Progression -->
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-2">
                    <span id="exploitStatusText">Initialisation...</span>
                    <span id="exploitProgressText">0%</span>
                </div>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" 
                         id="exploitProgressBar" role="progressbar" style="width: 0%">
                        0%
                    </div>
                </div>
            </div>

            <!-- Informations en temps r√©el -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="card border-info">
                        <div class="card-body text-center p-2">
                            <h6 id="sessionsCount">0</h6>
                            <small>Sessions ouvertes</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-warning">
                        <div class="card-body text-center p-2">
                            <h6 id="vulnsFound">0</h6>
                            <small>Vuln√©rabilit√©s</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-success">
                        <div class="card-body text-center p-2">
                            <h6 id="credsFound">0</h6>
                            <small>Credentials</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Actions -->
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="viewExploitDetails()" id="exploitDetailsBtn">
                    üëÅÔ∏è Voir d√©tails
                </button>
                <button class="btn btn-outline-danger" onclick="cancelExploit()" id="exploitCancelBtn">
                    üõë Arr√™ter
                </button>
            </div>
        </div>
    </div>

    <!-- Presets rapides -->
    <div class="row mt-3">
        <div class="col-md-12">
            <div class="card border-primary">
                <div class="card-header bg-primary text-white">
                    <h6>üß™ Tests rapides sur DVWA</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <button class="btn btn-outline-primary w-100 mb-2" onclick="loadDVWAHttpTest()">
                                üåê Test HTTP (PHP CGI)
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-outline-info w-100 mb-2" onclick="loadFTPTest()">
                                üìÅ Test FTP (VSFTPD)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentExploitTaskId = null;
let exploitMonitoringInterval = null;
let customExploits = JSON.parse(localStorage.getItem('customExploits') || '[]');

// Informations sur les exploits
const exploitInfo = {
    'exploit/multi/http/php_cgi_arg_injection': {
        name: 'PHP CGI Argument Injection',
        description: 'Exploite la vuln√©rabilit√© CVE-2012-1823 dans PHP-CGI',
        payload: 'php/reverse_php',
        ports: [80, 443, 8080],
        requirements: 'PHP-CGI avec query strings'
    },
    'exploit/unix/ftp/vsftpd_234_backdoor': {
        name: 'VSFTPD 2.3.4 Backdoor',
        description: 'Exploite la backdoor dans VSFTPD version 2.3.4',
        payload: 'cmd/unix/interact',
        ports: [21],
        requirements: 'VSFTPD 2.3.4 avec backdoor'
    }
};

// Charger les exploits personnalis√©s au d√©marrage
document.addEventListener('DOMContentLoaded', function() {
    loadCustomExploits();
});

document.getElementById('exploitationForm').addEventListener('submit', function(e) {
    e.preventDefault();
    startExploitation();
});

function updateExploitInfo() {
    const selectedExploit = document.getElementById('exploit_module').value;
    const customField = document.getElementById('customExploitField');
    const infoCard = document.getElementById('exploitInfoCard');
    const autoPayload = document.getElementById('autoPayload');
    
    if (selectedExploit === 'custom') {
        customField.style.display = 'block';
        infoCard.style.display = 'none';
        autoPayload.textContent = 'D√©pend de l\'exploit';
        document.getElementById('custom_exploit_path').required = true;
    } else if (selectedExploit && exploitInfo[selectedExploit]) {
        customField.style.display = 'none';
        document.getElementById('custom_exploit_path').required = false;
        
        const info = exploitInfo[selectedExploit];
        autoPayload.textContent = info.payload;
        
        document.getElementById('exploitInfoTitle').textContent = `‚ÑπÔ∏è ${info.name}`;
        document.getElementById('exploitInfoContent').innerHTML = `
            <p><strong>Description:</strong> ${info.description}</p>
            <p><strong>Ports typiques:</strong> ${info.ports.join(', ')}</p>
            <p><strong>Pr√©requis:</strong> ${info.requirements}</p>
        `;
        
        infoCard.style.display = 'block';
    } else {
        customField.style.display = 'none';
        infoCard.style.display = 'none';
        autoPayload.textContent = 'Auto-s√©lection';
        document.getElementById('custom_exploit_path').required = false;
    }
}

function loadCustomExploits() {
    const select = document.getElementById('exploit_module');
    
    // Supprimer les anciens exploits personnalis√©s
    const existingCustom = select.querySelectorAll('option[data-custom="true"]');
    existingCustom.forEach(option => option.remove());
    
    // Ajouter les exploits personnalis√©s
    customExploits.forEach(exploit => {
        const option = document.createElement('option');
        option.value = exploit.path;
        option.textContent = `üîß ${exploit.name || exploit.path}`;
        option.setAttribute('data-custom', 'true');
        
        // Ins√©rer avant l'option "Ajouter"
        const customOption = select.querySelector('option[value="custom"]');
        select.insertBefore(option, customOption);
    });
}

function saveCustomExploit(path, name = null) {
    const exploit = {
        path: path,
        name: name || path.split('/').pop(),
        addedAt: new Date().toISOString()
    };
    
    // √âviter les doublons
    if (!customExploits.find(e => e.path === path)) {
        customExploits.push(exploit);
        localStorage.setItem('customExploits', JSON.stringify(customExploits));
        loadCustomExploits();
        showNotification(`‚úÖ Exploit personnalis√© ajout√©: ${path}`, 'success');
    }
}

function startExploitation() {
    const target = document.getElementById('target').value.trim();
    const port = parseInt(document.getElementById('port').value);
    let selectedModule = document.getElementById('exploit_module').value;
    
    if (!target || !port) {
        alert('‚ö†Ô∏è Veuillez sp√©cifier une cible et un port');
        return;
    }
    
    // Gestion de l'exploit personnalis√©
    if (selectedModule === 'custom') {
        const customPath = document.getElementById('custom_exploit_path').value.trim();
        if (!customPath) {
            alert('‚ö†Ô∏è Veuillez sp√©cifier le chemin de l\'exploit personnalis√©');
            return;
        }
        selectedModule = customPath;
        
        // Sauvegarder l'exploit personnalis√© pour r√©utilisation
        saveCustomExploit(customPath);
    }
    
    const data = {
        target: target,
        port: port,
        exploit_module: selectedModule,
        options: {
            mode: 'exploit', // Toujours en mode exploitation
            lhost: '172.20.0.2', // IP fixe
            lport: '4444' // Port fixe
        }
    };
    
    // Ajouter les variables personnalis√©es
    const customOptions = document.getElementById('custom_options').value;
    if (customOptions) {
        customOptions.split('\n').forEach(line => {
            const [key, value] = line.split('=');
            if (key && value) {
                data.options[key.trim()] = value.trim();
            }
        });
    }
    
    // Configuration automatique du payload
    if (exploitInfo[selectedModule]) {
        data.options.payload = exploitInfo[selectedModule].payload;
    }
    
    console.log('üéØ Donn√©es envoy√©es:', data);
    
    document.getElementById('startExploitBtn').disabled = true;
    document.getElementById('startExploitBtn').innerHTML = 'üîÑ Lancement...';
    
    fetch('/huntkit/api/metasploit/exploitation/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentExploitTaskId = data.task_id;
            showExploitMonitoring();
            startExploitTaskMonitoring();
            showNotification('‚úÖ ' + data.message, 'success');
        } else {
            showNotification('‚ùå ' + data.error, 'danger');
            resetExploitForm();
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('‚ùå Erreur de connexion', 'danger');
        resetExploitForm();
    });
}

function showExploitMonitoring() {
    document.getElementById('exploitMonitoringCard').style.display = 'block';
    document.getElementById('exploitMonitoringCard').scrollIntoView({behavior: 'smooth'});
}

function startExploitTaskMonitoring() {
    if (!currentExploitTaskId) return;
    
    updateExploitTaskStatus();
    exploitMonitoringInterval = setInterval(updateExploitTaskStatus, 3000);
}

function updateExploitTaskStatus() {
    if (!currentExploitTaskId) return;
    
    fetch(`/tasks/api/${currentExploitTaskId}/status`)
        .then(response => response.json())
        .then(data => {
            if (data.success !== false) {
                updateExploitProgressUI(data);
                
                if (data.result && data.result.parsed_result) {
                    const parsed = data.result.parsed_result;
                    document.getElementById('sessionsCount').textContent = parsed.sessions_opened || 0;
                    document.getElementById('vulnsFound').textContent = (parsed.vulnerabilities_found || []).length;
                    document.getElementById('credsFound').textContent = (parsed.credentials_found || []).length;
                }
                
                if (data.unified_state === 'SUCCESS' || data.unified_state === 'FAILURE') {
                    stopExploitTaskMonitoring();
                    
                    if (data.unified_state === 'SUCCESS') {
                        setTimeout(() => {
                            window.location.href = `/tasks/${currentExploitTaskId}/results`;
                        }, 3000);
                    }
                }
            }
        })
        .catch(error => {
            console.error('Erreur monitoring exploit:', error);
        });
}

function updateExploitProgressUI(data) {
    const progress = data.unified_progress || data.progress || 0;
    const status = data.unified_status || data.status || 'En cours...';
    const state = data.unified_state || data.state || 'PENDING';
    
    const progressBar = document.getElementById('exploitProgressBar');
    progressBar.style.width = `${progress}%`;
    progressBar.textContent = `${progress}%`;
    
    document.getElementById('exploitStatusText').textContent = status;
    document.getElementById('exploitProgressText').textContent = `${progress}%`;
    
    const taskStatus = document.getElementById('exploitTaskStatus');
    if (state === 'SUCCESS') {
        taskStatus.textContent = 'Termin√© ‚úÖ';
        taskStatus.className = 'badge bg-success';
        progressBar.className = 'progress-bar bg-success';
        progressBar.classList.remove('progress-bar-animated');
    } else if (state === 'FAILURE') {
        taskStatus.textContent = 'Erreur ‚ùå';
        taskStatus.className = 'badge bg-danger';
        progressBar.className = 'progress-bar bg-danger';
        progressBar.classList.remove('progress-bar-animated');
    }
}

function stopExploitTaskMonitoring() {
    if (exploitMonitoringInterval) {
        clearInterval(exploitMonitoringInterval);
        exploitMonitoringInterval = null;
    }
}

function resetExploitForm() {
    document.getElementById('startExploitBtn').disabled = false;
    document.getElementById('startExploitBtn').innerHTML = 'üöÄ Lancer l\'exploitation';
    document.getElementById('exploitMonitoringCard').style.display = 'none';
    currentExploitTaskId = null;
}

// Presets
function loadDVWAHttpTest() {
    document.getElementById('target').value = '172.20.0.10';
    document.getElementById('port').value = '80';
    document.getElementById('exploit_module').value = 'exploit/multi/http/php_cgi_arg_injection';
    updateExploitInfo();
}

function loadFTPTest() {
    document.getElementById('target').value = 'localhost';
    document.getElementById('port').value = '21';
    document.getElementById('exploit_module').value = 'exploit/unix/ftp/vsftpd_234_backdoor';
    updateExploitInfo();
}

function loadExploitPresets() {
    const presets = [
        { name: 'DVWA HTTP', target: '172.20.0.10', port: 80, exploit: 'exploit/multi/http/php_cgi_arg_injection' },
        { name: 'FTP Local', target: 'localhost', port: 21, exploit: 'exploit/unix/ftp/vsftpd_234_backdoor' }
    ];
    
    let options = presets.map(p => `${p.name}: ${p.target}:${p.port} (${p.exploit.split('/').pop()})`).join('\n');
    alert('üìã Presets disponibles:\n\n' + options);
}

function showExploitGuide() {
    alert(`üìñ Guide rapide Metasploit:

üéØ Workflow:
1. S√©lectionner une cible (IP/hostname)
2. Sp√©cifier le port de la vuln√©rabilit√©
3. Choisir l'exploit adapt√©
4. Configuration automatique (LHOST=172.20.0.2)
5. Lancer l'exploitation

‚ö° Exploits disponibles:
‚Ä¢ PHP CGI Injection ‚Üí Ports web (80, 443, 8080)
‚Ä¢ VSFTPD Backdoor ‚Üí Port FTP (21)
‚Ä¢ Exploits personnalis√©s ‚Üí Chemin manuel

üîß Configuration auto:
‚Ä¢ LHOST: 172.20.0.2 (fixe)
‚Ä¢ LPORT: 4444 (automatique)
‚Ä¢ Payload: Selon l'exploit`);
}

function viewExploitDetails() {
    if (currentExploitTaskId) {
        window.open(`/tasks/${currentExploitTaskId}/status`, '_blank');
    }
}

function cancelExploit() {
    if (!currentExploitTaskId) return;
    
    if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir arr√™ter cette exploitation ?')) {
        fetch(`/tasks/api/${currentExploitTaskId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('‚úÖ Exploitation arr√™t√©e', 'info');
                stopExploitTaskMonitoring();
                resetExploitForm();
            } else {
                showNotification('‚ùå Impossible d\'arr√™ter l\'exploitation', 'danger');
            }
        });
    }
}

function showNotification(message, type, duration = 4000) {
    if (typeof window.showNotification === 'function') {
        window.showNotification(message, type, duration);
    } else {
        alert(message);
    }
}

// Nettoyage √† la fermeture
window.addEventListener('beforeunload', function() {
    if (exploitMonitoringInterval) clearInterval(exploitMonitoringInterval);
});
</script>

<style>
.card {
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border-radius: 8px;
}

.btn {
    border-radius: 6px;
}

.form-control {
    border-radius: 6px;
}

.progress {
    border-radius: 10px;
}

#exploitInfoCard {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
}
</style>

{% endblock %}
