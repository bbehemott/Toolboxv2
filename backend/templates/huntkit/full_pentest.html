{% extends "base.html" %}
{% block title %}Pentest Complet - HuntKit{% endblock %}
{% block content %}

<div class="container mt-4">
    <h2>üéØ Pentest Complet</h2>
    <p class="text-muted">Cha√Æne automatis√©e : D√©couverte ‚Üí Audit Web ‚Üí Force Brute</p>

    <div class="card mb-4">
        <div class="card-header">
            <h5>üéØ Configuration du pentest</h5>
        </div>
        <div class="card-body">
            <form id="fullPentestForm">
                <div class="row">
                    <div class="col-md-8">
                        <label for="target" class="form-label">Cible principale</label>
                        <input type="text" class="form-control" id="target" name="target" 
                               placeholder="192.168.1.0/24 ou example.com" required>
                        <div class="form-text">
                            Le scan d√©couvrira automatiquement les services disponibles
                        </div>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Options avanc√©es</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="deepScan" name="deepScan">
                            <label class="form-check-label" for="deepScan">
                                Scan approfondi
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="aggressiveBrute" name="aggressiveBrute">
                            <label class="form-check-label" for="aggressiveBrute">
                                Force brute agressive
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="webOnly" name="webOnly">
                            <label class="form-check-label" for="webOnly">
                                Applications web uniquement
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button type="submit" class="btn btn-danger btn-lg" id="startFullButton">
                        üöÄ Lancer le pentest complet
                    </button>
                    <button type="button" class="btn btn-outline-warning" onclick="showPentestInfo()">
                        ‚ÑπÔ∏è Phases du pentest
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Informations sur les phases -->
    <div class="card mb-4" id="pentestInfoCard" style="display: none;">
        <div class="card-header">
            <h6>üìã Phases du pentest automatique</h6>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <div class="card border-primary">
                        <div class="card-body text-center">
                            <h6>üåê Phase 1</h6>
                            <p><strong>D√©couverte</strong></p>
                            <small>Nmap : h√¥tes actifs + ports ouverts</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <h6>üï∑Ô∏è Phase 2</h6>
                            <p><strong>Audit Web</strong></p>
                            <small>Nikto + Nuclei + SQLMap sur services web</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <h6>üî® Phase 3</h6>
                            <p><strong>Force Brute</strong></p>
                            <small>Hydra sur SSH/FTP/autres services</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h6>üìä Phase 4</h6>
                            <p><strong>Rapport</strong></p>
                            <small>Consolidation et analyse des r√©sultats</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monitoring du pentest complet -->
    <div class="card" id="fullPentestMonitoringCard" style="display: none;">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>üéØ Pentest en cours</h5>
            <span class="badge bg-danger" id="fullPentestTaskStatus">En cours...</span>
        </div>
        <div class="card-body">
            <!-- Progression globale -->
            <div class="mb-3">
                <div class="d-flex justify-content-between mb-2">
                    <span id="fullPentestStatusText">Initialisation...</span>
                    <span id="fullPentestProgressText">0%</span>
                </div>
                <div class="progress" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-danger" 
                         id="fullPentestProgressBar" role="progressbar" style="width: 0%">
                        0%
                    </div>
                </div>
            </div>
            
            <!-- Phases d√©taill√©es -->
            <div class="row mb-3">
                <div class="col-md-3">
                    <div class="card border-light">
                        <div class="card-body p-2 text-center">
                            <div id="phase1Status" class="badge bg-secondary">Attente</div>
                            <div class="small mt-1">D√©couverte</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-light">
                        <div class="card-body p-2 text-center">
                            <div id="phase2Status" class="badge bg-secondary">Attente</div>
                            <div class="small mt-1">Audit Web</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-light">
                        <div class="card-body p-2 text-center">
                            <div id="phase3Status" class="badge bg-secondary">Attente</div>
                            <div class="small mt-1">Force Brute</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card border-light">
                        <div class="card-body p-2 text-center">
                            <div id="phase4Status" class="badge bg-secondary">Attente</div>
                            <div class="small mt-1">Rapport</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="viewFullPentestDetails()" id="fullPentestDetailsBtn">
                    üëÅÔ∏è Voir d√©tails
                </button>
                <button class="btn btn-outline-danger" onclick="cancelFullPentest()" id="fullPentestCancelBtn">
                    üõë Arr√™ter le pentest
                </button>
            </div>
        </div>
    </div>

    <!-- Avertissements -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="alert alert-danger">
                <h6>‚ö†Ô∏è IMPORTANT</h6>
                <ul class="mb-0">
                    <li>N'utilisez que sur vos propres syst√®mes</li>
                    <li>Obtenez une autorisation √©crite</li>
                    <li>Respectez les lois locales</li>
                    <li>Le pentest peut prendre plusieurs heures</li>
                </ul>
            </div>
        </div>
        <div class="col-md-6">
            <div class="alert alert-info">
                <h6>‚è±Ô∏è Temps estim√©</h6>
                <ul class="mb-0">
                    <li><strong>R√©seau /24:</strong> 30-180 minutes</li>
                    <li><strong>H√¥te unique:</strong> 15-60 minutes</li>
                    <li><strong>Mode web uniquement:</strong> 10-30 minutes</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
let currentFullPentestTaskId = null;
let fullPentestMonitoringInterval = null;

document.getElementById('fullPentestForm').addEventListener('submit', function(e) {
    e.preventDefault();
    startFullPentest();
});

function startFullPentest() {
    const target = document.getElementById('target').value.trim();
    
    if (!target) {
        alert('‚ö†Ô∏è Veuillez sp√©cifier une cible');
        return;
    }
    
    const options = {
        deep_scan: document.getElementById('deepScan').checked,
        aggressive_brute: document.getElementById('aggressiveBrute').checked,
        web_only: document.getElementById('webOnly').checked
    };
    
    // Confirmation importante
    if (!confirm(`‚ö†Ô∏è ATTENTION !\n\nVous allez lancer un pentest complet sur: ${target}\n\nCela inclut:\n- D√©couverte r√©seau\n- Scan de vuln√©rabilit√©s\n- Attaques par force brute\n\nAssurez-vous d'avoir l'autorisation !\n\nContinuer ?`)) {
        return;
    }
    
    // Deuxi√®me confirmation
    if (!confirm('Derni√®re confirmation: Avez-vous l\'autorisation √©crite pour tester cette cible ?')) {
        return;
    }
    
    // D√©sactiver le formulaire
    document.getElementById('startFullButton').disabled = true;
    document.getElementById('startFullButton').innerHTML = 'üîÑ Lancement...';
    
    // Lancer la t√¢che
    fetch('/huntkit/api/full-pentest/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            target: target,
            options: options
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentFullPentestTaskId = data.task_id;
            showFullPentestMonitoring();
            startFullPentestTaskMonitoring();
            showNotification('‚úÖ ' + data.message, 'success');
        } else {
            showNotification('‚ùå ' + data.error, 'danger');
            resetFullPentestForm();
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('‚ùå Erreur de connexion', 'danger');
        resetFullPentestForm();
    });
}

function showFullPentestMonitoring() {
    document.getElementById('fullPentestMonitoringCard').style.display = 'block';
    document.getElementById('pentestInfoCard').style.display = 'none';
}

function startFullPentestTaskMonitoring() {
    if (!currentFullPentestTaskId) return;
    
    updateFullPentestTaskStatus();
    fullPentestMonitoringInterval = setInterval(updateFullPentestTaskStatus, 5000);
}

function updateFullPentestTaskStatus() {
    if (!currentFullPentestTaskId) return;
    
    fetch(`/tasks/api/${currentFullPentestTaskId}/status`)
        .then(response => response.json())
        .then(data => {
            if (data.success !== false) {
                updateFullPentestProgressUI(data);
                updatePhasesStatus(data);
                
                if (data.unified_state === 'SUCCESS' || data.unified_state === 'FAILURE') {
                    stopFullPentestTaskMonitoring();
                    
                    if (data.unified_state === 'SUCCESS') {
                        setTimeout(() => {
                            window.location.href = `/tasks/${currentFullPentestTaskId}/results`;
                        }, 3000);
                    }
                }
            }
        })
        .catch(error => {
            console.error('Erreur monitoring pentest:', error);
        });
}

function updateFullPentestProgressUI(data) {
    const progress = data.unified_progress || data.progress || 0;
    const status = data.unified_status || data.status || 'En cours...';
    const state = data.unified_state || data.state || 'PENDING';
    
    const progressBar = document.getElementById('fullPentestProgressBar');
    progressBar.style.width = `${progress}%`;
    progressBar.textContent = `${progress}%`;
    
    document.getElementById('fullPentestStatusText').textContent = status;
    document.getElementById('fullPentestProgressText').textContent = `${progress}%`;
    
    const taskStatus = document.getElementById('fullPentestTaskStatus');
    if (state === 'SUCCESS') {
        taskStatus.textContent = 'Termin√© ‚úÖ';
        taskStatus.className = 'badge bg-success';
        progressBar.className = 'progress-bar bg-success';
        progressBar.classList.remove('progress-bar-animated');
    } else if (state === 'FAILURE') {
        taskStatus.textContent = 'Erreur ‚ùå';
        taskStatus.className = 'badge bg-danger';
        progressBar.className = 'progress-bar bg-danger';
        progressBar.classList.remove('progress-bar-animated');
    }
}

function updatePhasesStatus(data) {
    // D√©terminer la phase actuelle selon la progression
    const progress = data.unified_progress || 0;
    const status = data.unified_status || '';
    
    // Reset toutes les phases
    ['phase1Status', 'phase2Status', 'phase3Status', 'phase4Status'].forEach(id => {
        document.getElementById(id).className = 'badge bg-secondary';
        document.getElementById(id).textContent = 'Attente';
    });
    
    // Mettre √† jour selon la progression
    if (progress >= 10) {
        document.getElementById('phase1Status').className = 'badge bg-primary';
        document.getElementById('phase1Status').textContent = 'En cours';
    }
    if (progress >= 30) {
        document.getElementById('phase1Status').className = 'badge bg-success';
        document.getElementById('phase1Status').textContent = 'Termin√©';
        document.getElementById('phase2Status').className = 'badge bg-primary';
        document.getElementById('phase2Status').textContent = 'En cours';
    }
    if (progress >= 60) {
        document.getElementById('phase2Status').className = 'badge bg-success';
        document.getElementById('phase2Status').textContent = 'Termin√©';
        document.getElementById('phase3Status').className = 'badge bg-primary';
        document.getElementById('phase3Status').textContent = 'En cours';
    }
    if (progress >= 90) {
        document.getElementById('phase3Status').className = 'badge bg-success';
        document.getElementById('phase3Status').textContent = 'Termin√©';
        document.getElementById('phase4Status').className = 'badge bg-primary';
        document.getElementById('phase4Status').textContent = 'En cours';
    }
    if (progress >= 100) {
        document.getElementById('phase4Status').className = 'badge bg-success';
        document.getElementById('phase4Status').textContent = 'Termin√©';
    }
}

function stopFullPentestTaskMonitoring() {
    if (fullPentestMonitoringInterval) {
        clearInterval(fullPentestMonitoringInterval);
        fullPentestMonitoringInterval = null;
    }
}

function resetFullPentestForm() {
    document.getElementById('startFullButton').disabled = false;
    document.getElementById('startFullButton').innerHTML = 'üöÄ Lancer le pentest complet';
    document.getElementById('fullPentestMonitoringCard').style.display = 'none';
    currentFullPentestTaskId = null;
}

function showPentestInfo() {
    const card = document.getElementById('pentestInfoCard');
    card.style.display = card.style.display === 'none' ? 'block' : 'none';
}

function viewFullPentestDetails() {
    if (currentFullPentestTaskId) {
        window.open(`/tasks/${currentFullPentestTaskId}/status`, '_blank');
    }
}

function cancelFullPentest() {
    if (!currentFullPentestTaskId) return;
    
    if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir arr√™ter ce pentest complet ?\n\nToutes les phases en cours seront interrompues.')) {
        fetch(`/tasks/api/${currentFullPentestTaskId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('‚úÖ Pentest arr√™t√©', 'info');
                stopFullPentestTaskMonitoring();
                resetFullPentestForm();
            } else {
                showNotification('‚ùå Impossible d\'arr√™ter le pentest', 'danger');
            }
        });
    }
}

window.addEventListener('beforeunload', function() {
    stopFullPentestTaskMonitoring();
});
</script>

{% endblock %}
