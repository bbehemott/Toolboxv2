{% extends "base.html" %}
{% block title %}Dashboard des TÃ¢ches{% endblock %}
{% block content %}

<div class="container mt-4">
    <h2>ğŸ“Š Dashboard des TÃ¢ches Celery</h2>
    <p class="text-muted">Monitoring global de toutes les tÃ¢ches asynchrones</p>

    <!-- Actions rapides -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                    ğŸ”„ Actualiser
                </button>
                <button class="btn btn-outline-danger" onclick="purgeAllTasks()" title="Supprimer toutes les tÃ¢ches de l'historique">
                    ğŸ—‘ï¸ Purger l'historique
                </button>
            </div>
        </div>
    </div>

    <!-- Statistiques globales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <h4 class="card-title text-info" id="total-active">-</h4>
                    <p class="card-text">âš¡ TÃ¢ches actives</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h4 class="card-title text-warning" id="total-scheduled">-</h4>
                    <p class="card-text">â° En attente</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <h4 class="card-title text-success" id="total-completed">-</h4>
                    <p class="card-text">âœ… TerminÃ©es</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-danger">
                <div class="card-body">
                    <h4 class="card-title text-danger" id="total-failed">-</h4>
                    <p class="card-text">âŒ Ã‰chouÃ©es</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TÃ¢ches actives -->
    <div class="card mb-4" id="active-tasks-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>âš¡ TÃ¢ches en cours d'exÃ©cution</h5>
            <span class="badge bg-info" id="active-count">-</span>
        </div>
        <div class="card-body">
            <div id="active-tasks-list">
                <div class="text-muted text-center py-4">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Chargement des tÃ¢ches actives...
                </div>
            </div>
        </div>
    </div>

    <!-- Historique rÃ©cent -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>ğŸ“‹ Historique rÃ©cent</h5>
            <span class="badge bg-secondary" id="history-count">0</span>
        </div>
        <div class="card-body">
            <div id="recent-tasks-list">
                {% if tasks and tasks|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Nom</th>
                                    <th>Cible</th>
                                    <th>Statut</th>
                                    <th>Utilisateur</th>
                                    <th>DÃ©marrÃ©</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in tasks %}
                                <tr class="task-item" data-task-id="{{ task.task_id }}">
                                    <td>
                                        <span class="badge bg-{{ 'success' if task.status == 'completed' else 'warning' if task.status == 'running' else 'danger' if task.status == 'failed' else 'secondary' }}">
                                            {{ task.task_type }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong>{{ task.task_name }}</strong>
                                    </td>
                                    <td>
                                        <small>{{ task.target or 'N/A' }}</small>
                                    </td>
                                    <td>
                                        {% if task.status == 'completed' %}
                                            <span class="text-success">âœ… {{ task.status }}</span>
                                        {% elif task.status == 'failed' %}
                                            <span class="text-danger">âŒ {{ task.status }}</span>
                                        {% elif task.status == 'running' %}
                                            <span class="text-warning">âš¡ {{ task.status }}</span>
                                        {% else %}
                                            <span class="text-secondary">â³ {{ task.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ task.username or 'SystÃ¨me' }}</small>
                                    </td>
                                    <td>
                                        <small>{{ task.started_at }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('tasks.task_status', task_id=task.task_id) }}" 
                                               class="btn btn-outline-info" title="Voir dÃ©tails">
                                                ğŸ‘ï¸
                                            </a>
                                            <button class="btn btn-outline-warning" 
                                                    onclick="hideTaskFromHistory('{{ task.task_id }}')" 
                                                    title="Supprimer de l'historique">
                                                ğŸ—‘ï¸
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        ğŸ“­ Aucune tÃ¢che dans l'historique rÃ©cent
                        <br><small>Les tÃ¢ches terminÃ©es apparaÃ®tront ici</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
let refreshInterval;

document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Dashboard chargÃ© - Initialisation...');
    
    // DÃ©marrer le dashboard avec auto-refresh
    refreshDashboard();
    startAutoRefresh();
});

function startAutoRefresh() {
    refreshInterval = setInterval(refreshDashboard, 10000);
    console.log('ğŸ”„ Auto-refresh activÃ© (10s)');
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        console.log('â¹ï¸ Auto-refresh arrÃªtÃ©');
    }
}

function refreshDashboard() {
    console.log('ğŸ”„ Actualisation dashboard...');
    
    // Mettre Ã  jour les statistiques
    fetch('/tasks/api/real-stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('ğŸ“Š Stats reÃ§ues:', data.stats);
                updateStats(data.stats);
            } else {
                console.warn('âš ï¸ Erreur stats:', data.error);
                showDefaultStats();
            }
        })
        .catch(error => {
            console.error('âŒ Erreur rÃ©cupÃ©ration stats:', error);
            showDefaultStats();
        });
    
    // Mettre Ã  jour la liste des tÃ¢ches ET les progressions en temps rÃ©el
    fetch('/tasks/api/list?limit=20')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('ğŸ“‹ TÃ¢ches reÃ§ues:', data.tasks.length);
                
                // Mettre Ã  jour l'historique
                updateTasksList(data.tasks);
                document.getElementById('history-count').textContent = data.tasks.length;
                
                // Mettre Ã  jour les tÃ¢ches actives avec progression temps rÃ©el
                const now = new Date();
                const activeTasks = data.tasks.filter(task => {
                    // TÃ¢ches en cours
                    if (task.status === 'running' || task.status === 'pending' || task.status === 'started') {
                        return true;
                    }
                    
                    // Ou tÃ¢ches rÃ©cemment terminÃ©es (5 minutes)
                    if (task.completed_at || task.started_at) {
                        const taskTime = new Date(task.completed_at || task.started_at);
                        const diffMinutes = (now - taskTime) / (1000 * 60);
                        return diffMinutes < 5; // Afficher pendant 5 minutes aprÃ¨s completion
                    }
                    
                    return false;
                });
                
                if (activeTasks.length > 0) {
                    // Mettre Ã  jour chaque tÃ¢che active individuellement
                    activeTasks.forEach(task => {
                        updateSingleTaskDisplay(task);
                    });
                    
                    // Supprimer les tÃ¢ches qui ne sont plus actives
                    cleanupInactiveTasks(activeTasks);
                } else {
                    document.getElementById('active-tasks-list').innerHTML = `
                        <div class="text-center text-muted py-4">
                            ğŸ˜´ Aucune tÃ¢che en cours d'exÃ©cution
                            <br><small>Les tÃ¢ches rÃ©centes s'affichent ici pendant 5 minutes</small>
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('âŒ Erreur rÃ©cupÃ©ration tÃ¢ches:', error);
        });
}

function cleanupInactiveTasks(activeTasks) {
    const activeTaskIds = activeTasks.map(task => task.task_id);
    const container = document.getElementById('active-tasks-list');
    
    // Supprimer les tÃ¢ches qui ne sont plus dans la liste active
    const existingTasks = container.querySelectorAll('[id^="active-task-"]');
    existingTasks.forEach(taskElement => {
        const taskId = taskElement.id.replace('active-task-', '');
        if (!activeTaskIds.includes(taskId)) {
            console.log(`ğŸ—‘ï¸ Suppression tÃ¢che inactive: ${taskId}`);
            taskElement.remove();
        }
    });
}

async function fetchTaskStatus(taskId) {
    try {
        console.log(`ğŸ“¡ RÃ©cupÃ©ration statut pour: ${taskId}`);
        const response = await fetch(`/tasks/api/${taskId}/status`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`ğŸ“Š Statut reÃ§u pour ${taskId}:`, data);
        
        return data.success ? data : null;
    } catch (error) {
        console.error(`âŒ Erreur statut tÃ¢che ${taskId}:`, error);
        return null;
    }
}


function updateStats(stats) {
    // Mettre Ã  jour les statistiques affichÃ©es
    document.getElementById('total-active').textContent = stats.active || 0;
    document.getElementById('total-scheduled').textContent = stats.scheduled || 0;
    document.getElementById('total-completed').textContent = stats.completed || 0;
    document.getElementById('total-failed').textContent = stats.failed || 0;
    
    // Mettre Ã  jour le compteur des tÃ¢ches actives
    document.getElementById('active-count').textContent = stats.active || 0;
    
    // AMÃ‰LIORATION : Affichage dÃ©taillÃ© des tÃ¢ches actives
    if (stats.active > 0) {
        // RÃ©cupÃ©rer les dÃ©tails des tÃ¢ches actives
        fetchActiveTasksDetails();
    } else {
        document.getElementById('active-tasks-list').innerHTML = `
            <div class="text-center text-muted py-4">
                ğŸ˜´ Aucune tÃ¢che en cours d'exÃ©cution
            </div>
        `;
    }
}



function fetchActiveTasksDetails() {
    // CORRECTION : RÃ©cupÃ©rer TOUTES les tÃ¢ches rÃ©centes et filtrer cÃ´tÃ© client
    fetch('/tasks/api/list?limit=20')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.tasks.length > 0) {
                // Filtrer les tÃ¢ches qui sont soit running, soit trÃ¨s rÃ©centes (moins de 5 min)
                const now = new Date();
                const activeTasks = data.tasks.filter(task => {
                    // Si la tÃ¢che est en cours
                    if (task.status === 'running' || task.status === 'pending' || task.status === 'started') {
                        return true;
                    }
                    
                    // Ou si elle vient de se terminer (moins de 2 minutes)
                    if (task.completed_at || task.started_at) {
                        const taskTime = new Date(task.completed_at || task.started_at);
                        const diffMinutes = (now - taskTime) / (1000 * 60);
                        return diffMinutes < 2; // Afficher pendant 2 minutes aprÃ¨s completion
                    }
                    
                    return false;
                });
                
                if (activeTasks.length > 0) {
                    displayActiveTasksDetails(activeTasks);
                } else {
                    document.getElementById('active-tasks-list').innerHTML = `
                        <div class="text-center text-muted py-4">
                            ğŸ˜´ Aucune tÃ¢che en cours d'exÃ©cution
                            <br><small>Les tÃ¢ches rÃ©centes s'affichent ici pendant 2 minutes</small>
                        </div>
                    `;
                }
            } else {
                document.getElementById('active-tasks-list').innerHTML = `
                    <div class="alert alert-info">
                        <strong>âš¡ Monitoring Celery</strong><br>
                        <small>Consultez Flower pour plus de dÃ©tails: <a href="http://localhost:5555" target="_blank">http://localhost:5555</a></small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('âŒ Erreur rÃ©cupÃ©ration tÃ¢ches actives:', error);
            document.getElementById('active-tasks-list').innerHTML = `
                <div class="alert alert-warning">
                    <strong>âš ï¸ Erreur de rÃ©cupÃ©ration</strong><br>
                    <small>Consultez <a href="http://localhost:5555" target="_blank">Flower</a> pour le monitoring en temps rÃ©el</small>
                </div>
            `;
        });
}

function displayActiveTasksDetails(tasks) {
    const container = document.getElementById('active-tasks-list');
    
    // Vider le conteneur au dÃ©but
    if (container.innerHTML.includes('Aucune tÃ¢che') || container.innerHTML.includes('Monitoring Celery')) {
        container.innerHTML = '';
    }
    
    tasks.forEach(task => {
        // CrÃ©er ou mettre Ã  jour chaque tÃ¢che
        updateSingleTaskDisplay(task);
    });
}


function updateSingleTaskDisplay(task) {
    // RÃ©cupÃ©rer le statut dÃ©taillÃ© en temps rÃ©el
    fetchTaskStatus(task.task_id).then(status => {
        // DÃ©terminer les valeurs d'affichage
        let progressPercent = 0;
        let statusText = task.status;
        let phase = '';
        let badgeClass = 'secondary';
        let badgeText = 'En attente';
        let progressClass = 'bg-info';
        
        if (status && status.success !== false) {
            progressPercent = status.unified_progress || status.progress || 0;
            statusText = status.unified_status || status.status || statusText;
            phase = status.meta?.phase || status.celery_info?.phase || '';
        }
        
        // Adapter selon le statut de la tÃ¢che
        if (task.status === 'completed') {
            badgeClass = 'success';
            badgeText = 'TerminÃ©';
            progressClass = 'bg-success';
            progressPercent = 100;
        } else if (task.status === 'failed') {
            badgeClass = 'danger';
            badgeText = 'Ã‰chouÃ©';
            progressClass = 'bg-danger';
        } else if (task.status === 'running') {
            badgeClass = 'warning';
            badgeText = 'En cours';
            progressClass = 'bg-warning';
        }
        
        const taskHtml = `
            <div class="card mb-3 border-${badgeClass}" id="active-task-${task.task_id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="card-title mb-1">
                                ${task.status === 'completed' ? 'âœ…' : task.status === 'failed' ? 'âŒ' : 'âš¡'} 
                                ${task.task_name}
                            </h6>
                            <small class="text-muted">ğŸ¯ ${task.target}</small>
                            ${phase ? `<br><small class="text-info">ğŸ“ Phase: ${phase}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${badgeClass} ${badgeClass === 'warning' ? 'text-dark' : ''}">${badgeText}</span><br>
                            <small class="text-muted">${task.started_at}</small>
                        </div>
                    </div>
                    
                    <!-- Barre de progression dynamique -->
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar ${task.status === 'running' ? 'progress-bar-striped progress-bar-animated' : ''} ${progressClass}" 
                             role="progressbar" 
                             style="width: ${progressPercent}%"
                             id="progress-${task.task_id}">
                            ${progressPercent}%
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="status-text-${task.task_id}">
                            ğŸ“Š ${statusText}
                        </small>
                        <div>
                            <a href="/tasks/${task.task_id}/status" class="btn btn-sm btn-outline-primary">
                                ğŸ‘ï¸ Voir dÃ©tails
                            </a>
                            ${task.status === 'running' ? 
                                `<button class="btn btn-sm btn-outline-danger" onclick="cancelTask('${task.task_id}')">ğŸ›‘ Annuler</button>` : 
                                `<button class="btn btn-sm btn-outline-warning" onclick="hideTaskFromHistory('${task.task_id}')">ğŸ—‘ï¸ Masquer</button>`
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const existingTask = document.getElementById(`active-task-${task.task_id}`);
        const container = document.getElementById('active-tasks-list');
        
        if (existingTask) {
            existingTask.outerHTML = taskHtml;
        } else {
            container.innerHTML += taskHtml;
        }
    }).catch(error => {
        console.error(`âŒ Erreur mise Ã  jour tÃ¢che ${task.task_id}:`, error);
    });
}



function cancelTask(taskId) {
    if (!confirm('âš ï¸ ÃŠtes-vous sÃ»r de vouloir annuler cette tÃ¢che ?')) {
        return;
    }
    
    fetch(`/tasks/api/${taskId}/cancel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('âœ… TÃ¢che annulÃ©e avec succÃ¨s', 'success');
            // Actualiser le dashboard
            setTimeout(() => refreshDashboard(), 1000);
        } else {
            showNotification('âŒ Erreur: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('âŒ Erreur annulation:', error);
        showNotification('âŒ Erreur de connexion', 'danger');
    });
}

function showDefaultStats() {
    // Afficher des stats par dÃ©faut en cas d'erreur
    document.getElementById('total-active').textContent = '0';
    document.getElementById('total-scheduled').textContent = '0';
    document.getElementById('total-completed').textContent = '?';
    document.getElementById('total-failed').textContent = '?';
    document.getElementById('active-count').textContent = '0';
}

function updateTasksList(tasks) {
    const listContainer = document.getElementById('recent-tasks-list');
    
    if (tasks.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center text-muted py-4">
                ğŸ“­ Aucune tÃ¢che dans l'historique rÃ©cent
                <br><small>Les tÃ¢ches terminÃ©es apparaÃ®tront ici</small>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Nom</th>
                        <th>Cible</th>
                        <th>Statut</th>
                        <th>Utilisateur</th>
                        <th>DÃ©marrÃ©</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    tasks.forEach(task => {
        const statusClass = task.status === 'completed' ? 'success' : 
                           task.status === 'running' ? 'warning' : 
                           task.status === 'failed' ? 'danger' : 'secondary';
        
        const statusIcon = task.status === 'completed' ? 'âœ…' : 
                          task.status === 'running' ? 'âš¡' : 
                          task.status === 'failed' ? 'âŒ' : 'â³';
        
        html += `
            <tr class="task-item" data-task-id="${task.task_id}">
                <td>
                    <span class="badge bg-${statusClass}">
                        ${task.task_type || 'Task'}
                    </span>
                </td>
                <td><strong>${task.task_name || 'Sans nom'}</strong></td>
                <td><small>${task.target || 'N/A'}</small></td>
                <td><span class="text-${statusClass}">${statusIcon} ${task.status}</span></td>
                <td><small>${task.username || 'SystÃ¨me'}</small></td>
                <td><small>${task.started_at || 'N/A'}</small></td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="/tasks/${task.task_id}/status" class="btn btn-outline-info" title="Voir dÃ©tails">ğŸ‘ï¸</a>
                        {% if current_user.role in ['admin', 'pentester'] %}
                        <button class="btn btn-outline-success" 
                                onclick="showAssignTaskModal('${task.task_id}')" 
                                title="Attribuer Ã  un invitÃ©">ğŸ“¤</button>
                        {% endif %}
                        <button class="btn btn-outline-warning" onclick="hideTaskFromHistory('${task.task_id}')" title="Supprimer">ğŸ—‘ï¸</button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    listContainer.innerHTML = html;
}

function hideTaskFromHistory(taskId) {
    console.log(`ğŸ—‘ï¸ Masquage tÃ¢che: ${taskId}`);
    
    if (!confirm('Voulez-vous vraiment masquer cette tÃ¢che de l\'historique ?')) {
        return;
    }
    
    fetch(`/tasks/api/task/${taskId}/hide-from-history`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('âœ… TÃ¢che masquÃ©e avec succÃ¨s', 'success');
            
            // Supprimer visuellement l'Ã©lÃ©ment
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskElement) {
                taskElement.style.transition = 'opacity 0.3s';
                taskElement.style.opacity = '0';
                setTimeout(() => {
                    taskElement.remove();
                    // Actualiser le compteur
                    const remaining = document.querySelectorAll('.task-item').length - 1;
                    document.getElementById('history-count').textContent = remaining;
                }, 300);
            }
        } else {
            showNotification('âŒ Erreur: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('âŒ Erreur rÃ©seau:', error);
        showNotification('âŒ Erreur de connexion', 'danger');
    });
}


function purgeAllTasks() {
    console.log('ğŸ—‘ï¸ Tentative purge complÃ¨te');
    
    if (!confirm('âš ï¸ ATTENTION: Voulez-vous vraiment supprimer TOUTES les tÃ¢ches terminÃ©es de l\'historique ?\n\nCette action est irrÃ©versible.')) {
        return;
    }
    
    // Afficher le loading sur le bouton
    const purgeButton = document.querySelector('button[onclick="purgeAllTasks()"]');
    const originalText = purgeButton.innerHTML;
    purgeButton.innerHTML = 'ğŸ”„ Purge en cours...';
    purgeButton.disabled = true;
    
    fetch('/tasks/api/cleanup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            days: 0  // 0 = supprimer toutes les tÃ¢ches terminÃ©es
        })
    })
    .then(response => {
        console.log(`ğŸ“¡ RÃ©ponse purge: ${response.status}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('ğŸ“Š RÃ©sultat purge:', data);
        
        if (data.success) {
            showNotification(`âœ… ${data.message}`, 'success');
            
            // Recharger la page aprÃ¨s 2 secondes
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showNotification(`âŒ Erreur: ${data.error}`, 'danger');
            
            // Restaurer le bouton
            purgeButton.innerHTML = originalText;
            purgeButton.disabled = false;
        }
    })
    .catch(error => {
        console.error('âŒ Erreur purge:', error);
        showNotification(`âŒ Erreur: ${error.message}`, 'danger');
        
        // Restaurer le bouton
        purgeButton.innerHTML = originalText;
        purgeButton.disabled = false;
    });
}

function showNotification(message, type) {
    console.log(`ğŸ“¢ Notification: ${message} (${type})`);
    
    // Supprimer les anciennes notifications
    const existingNotifications = document.querySelectorAll('.notification-custom');
    existingNotifications.forEach(n => n.remove());
    
    // CrÃ©er nouvelle notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed notification-custom`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 350px; max-width: 500px;';
    notification.innerHTML = `
        <strong>${type === 'success' ? 'âœ…' : 'âŒ'}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-suppression
    setTimeout(() => {
        if (notification && notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Nettoyer l'interval quand on quitte la page
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});

// Ajout dans le dashboard des tÃ¢ches
function showAssignTaskModal(taskId) {
    document.getElementById('taskToAssign').value = taskId;
    
    // Charger la liste des invitÃ©s
    fetch('/api/guests')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('guestSelect');
                select.innerHTML = '<option value="">Choisir un invitÃ©...</option>';
                
                data.guests.forEach(guest => {
                    const option = document.createElement('option');
                    option.value = guest.id;
                    option.textContent = guest.username;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erreur chargement invitÃ©s:', error);
            showAlert('Erreur lors du chargement des invitÃ©s', 'danger');
        });
    
    new bootstrap.Modal(document.getElementById('assignTaskModal')).show();
}

function assignTaskToGuest() {
    const taskId = document.getElementById('taskToAssign').value;
    const guestId = document.getElementById('guestSelect').value;
    const message = document.getElementById('assignMessage').value;
    
    if (!guestId) {
        showAlert('Veuillez sÃ©lectionner un invitÃ©', 'warning');
        return;
    }
    
    fetch(`/api/${taskId}/assign`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            guest_id: parseInt(guestId),
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('assignTaskModal')).hide();
        } else {
            showAlert(data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Erreur attribution:', error);
        showAlert('Erreur lors de l\'attribution', 'danger');
    });
}

</script>

{% endblock %}
