{% extends "base.html" %}
{% block title %}Dashboard des T√¢ches{% endblock %}
{% block content %}

<div class="container mt-4">
    <h2>üìä Dashboard des T√¢ches Celery</h2>
    <p class="text-muted">Monitoring global de toutes les t√¢ches asynchrones</p>

    <!-- Actions rapides -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between">
                <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                    üîÑ Actualiser
                </button>
                <button class="btn btn-outline-danger" onclick="purgeAllTasks()" title="Supprimer toutes les t√¢ches de l'historique">
                    üóëÔ∏è Purger l'historique
                </button>
            </div>
        </div>
    </div>

    <!-- Statistiques globales -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center border-info">
                <div class="card-body">
                    <h4 class="card-title text-info" id="total-active">-</h4>
                    <p class="card-text">‚ö° T√¢ches actives</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-warning">
                <div class="card-body">
                    <h4 class="card-title text-warning" id="total-scheduled">-</h4>
                    <p class="card-text">‚è∞ En attente</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-success">
                <div class="card-body">
                    <h4 class="card-title text-success" id="total-completed">-</h4>
                    <p class="card-text">‚úÖ Termin√©es</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center border-danger">
                <div class="card-body">
                    <h4 class="card-title text-danger" id="total-failed">-</h4>
                    <p class="card-text">‚ùå √âchou√©es</p>
                </div>
            </div>
        </div>
    </div>

    <!-- T√¢ches actives -->
    <div class="card mb-4" id="active-tasks-card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>‚ö° T√¢ches en cours d'ex√©cution</h5>
            <span class="badge bg-info" id="active-count">-</span>
        </div>
        <div class="card-body">
            <div id="active-tasks-list">
                <div class="text-muted text-center py-4">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    Chargement des t√¢ches actives...
                </div>
            </div>
        </div>
    </div>

    <!-- Historique r√©cent -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>üìã Historique r√©cent</h5>
            <span class="badge bg-secondary" id="history-count">0</span>
        </div>
        <div class="card-body">
            <div id="recent-tasks-list">
                {% if tasks and tasks|length > 0 %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th>Type</th>
                                    <th>Nom</th>
                                    <th>Cible</th>
                                    <th>Statut</th>
                                    <th>Utilisateur</th>
                                    <th>D√©marr√©</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for task in tasks %}
                                <tr class="task-item" data-task-id="{{ task.task_id }}">
                                    <td>
                                        <span class="badge bg-{{ 'success' if task.status == 'completed' else 'warning' if task.status == 'running' else 'danger' if task.status == 'failed' else 'secondary' }}">
                                            {{ task.task_type }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong>{{ task.task_name }}</strong>
                                    </td>
                                    <td>
                                        <small>{{ task.target or 'N/A' }}</small>
                                    </td>
                                    <td>
                                        {% if task.status == 'completed' %}
                                            <span class="text-success">‚úÖ {{ task.status }}</span>
                                        {% elif task.status == 'failed' %}
                                            <span class="text-danger">‚ùå {{ task.status }}</span>
                                        {% elif task.status == 'running' %}
                                            <span class="text-warning">‚ö° {{ task.status }}</span>
                                        {% else %}
                                            <span class="text-secondary">‚è≥ {{ task.status }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ task.username or 'Syst√®me' }}</small>
                                    </td>
                                    <td>
                                        <small>{{ task.started_at }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{{ url_for('tasks.task_status', task_id=task.task_id) }}" 
                                               class="btn btn-outline-info" title="Voir d√©tails">
                                                üëÅÔ∏è
                                            </a>
                                            <button class="btn btn-outline-warning" 
                                                    onclick="hideTaskFromHistory('{{ task.task_id }}')" 
                                                    title="Supprimer de l'historique">
                                                üóëÔ∏è
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        üì≠ Aucune t√¢che dans l'historique r√©cent
                        <br><small>Les t√¢ches termin√©es appara√Ætront ici</small>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
let refreshInterval;
const userRole = '{{ current_user.role }}';
console.log('üîë R√¥le utilisateur:', userRole);

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Dashboard charg√© - Initialisation...');
    
    // D√©marrer le dashboard avec auto-refresh
    refreshDashboard();
    startAutoRefresh();
});

function startAutoRefresh() {
    refreshInterval = setInterval(refreshDashboard, 10000);
    console.log('üîÑ Auto-refresh activ√© (10s)');
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        console.log('‚èπÔ∏è Auto-refresh arr√™t√©');
    }
}

function refreshDashboard() {
    console.log('üîÑ Actualisation dashboard...');
    
    // Mettre √† jour les statistiques
    fetch('/tasks/api/real-stats')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('üìä Stats re√ßues:', data.stats);
                updateStats(data.stats);
            } else {
                console.warn('‚ö†Ô∏è Erreur stats:', data.error);
                showDefaultStats();
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur r√©cup√©ration stats:', error);
            showDefaultStats();
        });
    
    // Mettre √† jour la liste des t√¢ches ET les progressions en temps r√©el
    fetch('/tasks/api/list?limit=20')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('üìã T√¢ches re√ßues:', data.tasks.length);
                
                // Mettre √† jour l'historique
                updateTasksList(data.tasks);
                document.getElementById('history-count').textContent = data.tasks.length;
                
                // Mettre √† jour les t√¢ches actives avec progression temps r√©el
                const now = new Date();
                const activeTasks = data.tasks.filter(task => {
                    // T√¢ches en cours
                    if (task.status === 'running' || task.status === 'pending' || task.status === 'started') {
                        return true;
                    }
                    
                    // Ou t√¢ches r√©cemment termin√©es (5 minutes)
                    if (task.completed_at || task.started_at) {
                        const taskTime = new Date(task.completed_at || task.started_at);
                        const diffMinutes = (now - taskTime) / (1000 * 60);
                        return diffMinutes < 5; // Afficher pendant 5 minutes apr√®s completion
                    }
                    
                    return false;
                });
                
                if (activeTasks.length > 0) {
                    // Mettre √† jour chaque t√¢che active individuellement
                    activeTasks.forEach(task => {
                        updateSingleTaskDisplay(task);
                    });
                    
                    // Supprimer les t√¢ches qui ne sont plus actives
                    cleanupInactiveTasks(activeTasks);
                } else {
                    document.getElementById('active-tasks-list').innerHTML = `
                        <div class="text-center text-muted py-4">
                            üò¥ Aucune t√¢che en cours d'ex√©cution
                            <br><small>Les t√¢ches r√©centes s'affichent ici pendant 5 minutes</small>
                        </div>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur r√©cup√©ration t√¢ches:', error);
        });
}

function cleanupInactiveTasks(activeTasks) {
    const activeTaskIds = activeTasks.map(task => task.task_id);
    const container = document.getElementById('active-tasks-list');
    
    // Supprimer les t√¢ches qui ne sont plus dans la liste active
    const existingTasks = container.querySelectorAll('[id^="active-task-"]');
    existingTasks.forEach(taskElement => {
        const taskId = taskElement.id.replace('active-task-', '');
        if (!activeTaskIds.includes(taskId)) {
            console.log(`üóëÔ∏è Suppression t√¢che inactive: ${taskId}`);
            taskElement.remove();
        }
    });
}

async function fetchTaskStatus(taskId) {
    try {
        console.log(`üì° R√©cup√©ration statut pour: ${taskId}`);
        const response = await fetch(`/tasks/api/${taskId}/status`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`üìä Statut re√ßu pour ${taskId}:`, data);
        
        return data.success ? data : null;
    } catch (error) {
        console.error(`‚ùå Erreur statut t√¢che ${taskId}:`, error);
        return null;
    }
}


function updateStats(stats) {
    // Mettre √† jour les statistiques affich√©es
    document.getElementById('total-active').textContent = stats.active || 0;
    document.getElementById('total-scheduled').textContent = stats.scheduled || 0;
    document.getElementById('total-completed').textContent = stats.completed || 0;
    document.getElementById('total-failed').textContent = stats.failed || 0;
    
    // Mettre √† jour le compteur des t√¢ches actives
    document.getElementById('active-count').textContent = stats.active || 0;
    
    // AM√âLIORATION : Affichage d√©taill√© des t√¢ches actives
    if (stats.active > 0) {
        // R√©cup√©rer les d√©tails des t√¢ches actives
        fetchActiveTasksDetails();
    } else {
        document.getElementById('active-tasks-list').innerHTML = `
            <div class="text-center text-muted py-4">
                üò¥ Aucune t√¢che en cours d'ex√©cution
            </div>
        `;
    }
}



function fetchActiveTasksDetails() {
    // CORRECTION : R√©cup√©rer TOUTES les t√¢ches r√©centes et filtrer c√¥t√© client
    fetch('/tasks/api/list?limit=20')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.tasks.length > 0) {
                // Filtrer les t√¢ches qui sont soit running, soit tr√®s r√©centes (moins de 5 min)
                const now = new Date();
                const activeTasks = data.tasks.filter(task => {
                    // Si la t√¢che est en cours
                    if (task.status === 'running' || task.status === 'pending' || task.status === 'started') {
                        return true;
                    }
                    
                    // Ou si elle vient de se terminer (moins de 2 minutes)
                    if (task.completed_at || task.started_at) {
                        const taskTime = new Date(task.completed_at || task.started_at);
                        const diffMinutes = (now - taskTime) / (1000 * 60);
                        return diffMinutes < 2; // Afficher pendant 2 minutes apr√®s completion
                    }
                    
                    return false;
                });
                
                if (activeTasks.length > 0) {
                    displayActiveTasksDetails(activeTasks);
                } else {
                    document.getElementById('active-tasks-list').innerHTML = `
                        <div class="text-center text-muted py-4">
                            üò¥ Aucune t√¢che en cours d'ex√©cution
                            <br><small>Les t√¢ches r√©centes s'affichent ici pendant 2 minutes</small>
                        </div>
                    `;
                }
            } else {
                document.getElementById('active-tasks-list').innerHTML = `
                    <div class="alert alert-info">
                        <strong>‚ö° Monitoring Celery</strong><br>
                        <small>Consultez Flower pour plus de d√©tails: <a href="http://localhost:5555" target="_blank">http://localhost:5555</a></small>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('‚ùå Erreur r√©cup√©ration t√¢ches actives:', error);
            document.getElementById('active-tasks-list').innerHTML = `
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Erreur de r√©cup√©ration</strong><br>
                    <small>Consultez <a href="http://localhost:5555" target="_blank">Flower</a> pour le monitoring en temps r√©el</small>
                </div>
            `;
        });
}

function displayActiveTasksDetails(tasks) {
    const container = document.getElementById('active-tasks-list');
    
    // Vider le conteneur au d√©but
    if (container.innerHTML.includes('Aucune t√¢che') || container.innerHTML.includes('Monitoring Celery')) {
        container.innerHTML = '';
    }
    
    tasks.forEach(task => {
        // Cr√©er ou mettre √† jour chaque t√¢che
        updateSingleTaskDisplay(task);
    });
}


function updateSingleTaskDisplay(task) {
    // R√©cup√©rer le statut d√©taill√© en temps r√©el
    fetchTaskStatus(task.task_id).then(status => {
        // D√©terminer les valeurs d'affichage
        let progressPercent = 0;
        let statusText = task.status;
        let phase = '';
        let badgeClass = 'secondary';
        let badgeText = 'En attente';
        let progressClass = 'bg-info';
        
        if (status && status.success !== false) {
            progressPercent = status.unified_progress || status.progress || 0;
            statusText = status.unified_status || status.status || statusText;
            phase = status.meta?.phase || status.celery_info?.phase || '';
        }
        
        // Adapter selon le statut de la t√¢che
        if (task.status === 'completed') {
            badgeClass = 'success';
            badgeText = 'Termin√©';
            progressClass = 'bg-success';
            progressPercent = 100;
        } else if (task.status === 'failed') {
            badgeClass = 'danger';
            badgeText = '√âchou√©';
            progressClass = 'bg-danger';
        } else if (task.status === 'running') {
            badgeClass = 'warning';
            badgeText = 'En cours';
            progressClass = 'bg-warning';
        }
        
        const taskHtml = `
            <div class="card mb-3 border-${badgeClass}" id="active-task-${task.task_id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                            <h6 class="card-title mb-1">
                                ${task.status === 'completed' ? '‚úÖ' : task.status === 'failed' ? '‚ùå' : '‚ö°'} 
                                ${task.task_name}
                            </h6>
                            <small class="text-muted">üéØ ${task.target}</small>
                            ${phase ? `<br><small class="text-info">üìç Phase: ${phase}</small>` : ''}
                        </div>
                        <div class="text-end">
                            <span class="badge bg-${badgeClass} ${badgeClass === 'warning' ? 'text-dark' : ''}">${badgeText}</span><br>
                            <small class="text-muted">${task.started_at}</small>
                        </div>
                    </div>
                    
                    <!-- Barre de progression dynamique -->
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar ${task.status === 'running' ? 'progress-bar-striped progress-bar-animated' : ''} ${progressClass}" 
                             role="progressbar" 
                             style="width: ${progressPercent}%"
                             id="progress-${task.task_id}">
                            ${progressPercent}%
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted" id="status-text-${task.task_id}">
                            üìä ${statusText}
                        </small>
                        <div>
                            <a href="/tasks/${task.task_id}/status" class="btn btn-sm btn-outline-primary">
                                üëÅÔ∏è Voir d√©tails
                            </a>
                            ${task.status === 'running' ? 
                                `<button class="btn btn-sm btn-outline-danger" onclick="cancelTask('${task.task_id}')">üõë Annuler</button>` : 
                                `<button class="btn btn-sm btn-outline-warning" onclick="hideTaskFromHistory('${task.task_id}')">üóëÔ∏è Masquer</button>`
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        const existingTask = document.getElementById(`active-task-${task.task_id}`);
        const container = document.getElementById('active-tasks-list');
        
        if (existingTask) {
            existingTask.outerHTML = taskHtml;
        } else {
            container.innerHTML += taskHtml;
        }
    }).catch(error => {
        console.error(`‚ùå Erreur mise √† jour t√¢che ${task.task_id}:`, error);
    });
}



function cancelTask(taskId) {
    if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir annuler cette t√¢che ?')) {
        return;
    }
    
    fetch(`/tasks/api/${taskId}/cancel`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ T√¢che annul√©e avec succ√®s', 'success');
            // Actualiser le dashboard
            setTimeout(() => refreshDashboard(), 1000);
        } else {
            showNotification('‚ùå Erreur: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur annulation:', error);
        showNotification('‚ùå Erreur de connexion', 'danger');
    });
}

function showDefaultStats() {
    // Afficher des stats par d√©faut en cas d'erreur
    document.getElementById('total-active').textContent = '0';
    document.getElementById('total-scheduled').textContent = '0';
    document.getElementById('total-completed').textContent = '?';
    document.getElementById('total-failed').textContent = '?';
    document.getElementById('active-count').textContent = '0';
}

function updateTasksList(tasks) {
    const listContainer = document.getElementById('recent-tasks-list');
    
    if (tasks.length === 0) {
        listContainer.innerHTML = `
            <div class="text-center text-muted py-4">
                üì≠ Aucune t√¢che dans l'historique r√©cent
                <br><small>Les t√¢ches termin√©es appara√Ætront ici</small>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>Type</th>
                        <th>Nom</th>
                        <th>Cible</th>
                        <th>Statut</th>
                        <th>Utilisateur</th>
                        <th>D√©marr√©</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    tasks.forEach(task => {
        const statusClass = task.status === 'completed' ? 'success' : 
                           task.status === 'running' ? 'warning' : 
                           task.status === 'failed' ? 'danger' : 'secondary';
        
        const statusIcon = task.status === 'completed' ? '‚úÖ' : 
                          task.status === 'running' ? '‚ö°' : 
                          task.status === 'failed' ? '‚ùå' : '‚è≥';
        
        html += `
            <tr class="task-item" data-task-id="${task.task_id}">
                <td>
                    <span class="badge bg-${statusClass}">
                        ${task.task_type || 'Task'}
                    </span>
                </td>
                <td><strong>${task.task_name || 'Sans nom'}</strong></td>
                <td><small>${task.target || 'N/A'}</small></td>
                <td><span class="text-${statusClass}">${statusIcon} ${task.status}</span></td>
                <td><small>${task.username || 'Syst√®me'}</small></td>
                <td><small>${task.started_at || 'N/A'}</small></td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <a href="/tasks/${task.task_id}/status" class="btn btn-outline-info" title="Voir d√©tails">üëÅÔ∏è</a>
        `;
        
        // Ajouter le bouton d'attribution seulement pour admin/pentester
        if (userRole === 'admin' || userRole === 'pentester') {
            html += `
                        <button class="btn btn-outline-success" 
                                onclick="showAssignTaskModal('${task.task_id}')" 
                                title="Attribuer √† un invit√©">üì§</button>
            `;
        }
        
        html += `
                        <button class="btn btn-outline-warning" onclick="hideTaskFromHistory('${task.task_id}')" title="Supprimer">üóëÔ∏è</button>
                    </div>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    listContainer.innerHTML = html;
}


function hideTaskFromHistory(taskId) {
    console.log(`üóëÔ∏è Masquage t√¢che: ${taskId}`);
    
    if (!confirm('Voulez-vous vraiment masquer cette t√¢che de l\'historique ?')) {
        return;
    }
    
    fetch(`/tasks/api/task/${taskId}/hide-from-history`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ T√¢che masqu√©e avec succ√®s', 'success');
            
            // Supprimer visuellement l'√©l√©ment
            const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskElement) {
                taskElement.style.transition = 'opacity 0.3s';
                taskElement.style.opacity = '0';
                setTimeout(() => {
                    taskElement.remove();
                    // Actualiser le compteur
                    const remaining = document.querySelectorAll('.task-item').length - 1;
                    document.getElementById('history-count').textContent = remaining;
                }, 300);
            }
        } else {
            showNotification('‚ùå Erreur: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur r√©seau:', error);
        showNotification('‚ùå Erreur de connexion', 'danger');
    });
}


function purgeAllTasks() {
    console.log('üóëÔ∏è Tentative purge compl√®te');
    
    if (!confirm('‚ö†Ô∏è ATTENTION: Voulez-vous vraiment supprimer TOUTES les t√¢ches termin√©es de l\'historique ?\n\nCette action est irr√©versible.')) {
        return;
    }
    
    // Afficher le loading sur le bouton
    const purgeButton = document.querySelector('button[onclick="purgeAllTasks()"]');
    const originalText = purgeButton.innerHTML;
    purgeButton.innerHTML = 'üîÑ Purge en cours...';
    purgeButton.disabled = true;
    
    fetch('/tasks/api/cleanup', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            days: 0  // 0 = supprimer toutes les t√¢ches termin√©es
        })
    })
    .then(response => {
        console.log(`üì° R√©ponse purge: ${response.status}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('üìä R√©sultat purge:', data);
        
        if (data.success) {
            showNotification(`‚úÖ ${data.message}`, 'success');
            
            // Recharger la page apr√®s 2 secondes
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showNotification(`‚ùå Erreur: ${data.error}`, 'danger');
            
            // Restaurer le bouton
            purgeButton.innerHTML = originalText;
            purgeButton.disabled = false;
        }
    })
    .catch(error => {
        console.error('‚ùå Erreur purge:', error);
        showNotification(`‚ùå Erreur: ${error.message}`, 'danger');
        
        // Restaurer le bouton
        purgeButton.innerHTML = originalText;
        purgeButton.disabled = false;
    });
}

function showNotification(message, type) {
    console.log(`üì¢ Notification: ${message} (${type})`);
    
    // Supprimer les anciennes notifications
    const existingNotifications = document.querySelectorAll('.notification-custom');
    existingNotifications.forEach(n => n.remove());
    
    // Cr√©er nouvelle notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed notification-custom`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 1060; min-width: 350px; max-width: 500px;';
    notification.innerHTML = `
        <strong>${type === 'success' ? '‚úÖ' : '‚ùå'}</strong> ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-suppression
    setTimeout(() => {
        if (notification && notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Nettoyer l'interval quand on quitte la page
window.addEventListener('beforeunload', function() {
    stopAutoRefresh();
});

// Ajout dans le dashboard des t√¢ches
function showAssignTaskModal(taskId) {
    document.getElementById('taskToAssign').value = taskId;
    
    // Charger la liste des invit√©s
    fetch('/tasks/api/guests')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('guestSelect');
                select.innerHTML = '<option value="">Choisir un invit√©...</option>';
                
                data.guests.forEach(guest => {
                    const option = document.createElement('option');
                    option.value = guest.id;
                    option.textContent = guest.username;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Erreur chargement invit√©s:', error);
            showAlert('Erreur lors du chargement des invit√©s', 'danger');
        });
    
    new bootstrap.Modal(document.getElementById('assignTaskModal')).show();
}

function assignTaskToGuest() {
    const taskId = document.getElementById('taskToAssign').value;
    const guestId = document.getElementById('guestSelect').value;
    const message = document.getElementById('assignMessage').value;
    
    if (!guestId) {
        showNotification('‚ö†Ô∏è Veuillez s√©lectionner un invit√©', 'warning');  // ‚Üê CHANGER showAlert en showNotification
        return;
    }
    
    fetch(`/tasks/api/${taskId}/assign`, {  // ‚Üê V√©rifiez que vous avez bien /tasks/ au d√©but
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            guest_id: parseInt(guestId),
            message: message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('‚úÖ ' + data.message, 'success');  // ‚Üê CHANGER showAlert en showNotification
            bootstrap.Modal.getInstance(document.getElementById('assignTaskModal')).hide();
        } else {
            showNotification('‚ùå ' + data.error, 'danger');  // ‚Üê CHANGER showAlert en showNotification
        }
    })
    .catch(error => {
        console.error('Erreur attribution:', error);
        showNotification('‚ùå Erreur lors de l\'attribution', 'danger');  // ‚Üê CHANGER showAlert en showNotification
    });
}


</script>

<div class="modal fade" id="assignTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üì§ Attribuer la t√¢che √† un invit√©</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="assignTaskForm">
                    <div class="mb-3">
                        <label class="form-label">S√©lectionner un invit√© :</label>
                        <select class="form-select" id="guestSelect" required>
                            <option value="">Choisir un invit√©...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message (optionnel) :</label>
                        <textarea class="form-control" id="assignMessage" 
                                  placeholder="Instructions pour l'invit√©..." rows="3"></textarea>
                    </div>
                    <input type="hidden" id="taskToAssign">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-success" onclick="assignTaskToGuest()">
                    üì§ Attribuer
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
